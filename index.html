<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Uplink</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background-color: #000; overflow: hidden; font-family: 'Courier New', monospace; user-select: none; -webkit-user-select: none; }
        
        /* THE CONTAINER - Hidden (opacity 0) until ready */
        #meet-container { 
            width: 100%; height: 100%; 
            opacity: 0; 
            transition: opacity 2s ease-in; /* Slow fade in for drama */
            filter: sepia(30%) hue-rotate(190deg) contrast(120%) saturate(110%);
        }

        /* CRT SCANLINE OVERLAY - Always on top */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%; z-index: 999; opacity: 0.6; mix-blend-mode: overlay;
        }

        /* THE BOOT SCREEN (Covers the ugly loading) */
        #boot-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 500;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #0f0; padding: 20px; text-align: center;
            cursor: pointer; /* Hints that it's clickable */
        }

        /* Pulsing Text */
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
        
        .glow-text { text-shadow: 0 0 10px #0f0, 0 0 20px #0f0; font-size: 14px; letter-spacing: 2px; line-height: 1.5; }
        
        /* The "Tap" hint is subtle */
        #interaction-trigger { 
            margin-top: 30px; 
            border: 1px solid #0f0; 
            padding: 10px 30px; 
            text-transform: uppercase; 
            font-size: 12px;
            background: rgba(0, 255, 0, 0.1);
        }

    </style>
</head>
<body>

    <div id="boot-screen" onclick="initializeUplink()">
        <div class="glow-text">
            > SYSTEM BOOT... OK<br>
            > ENCRYPTING FEED... OK<br>
            > BYPASSING FIREWALL... OK<br>
            <br>
            <span class="blink">AWAITING BIOMETRIC INPUT</span>
        </div>
        <div id="interaction-trigger">TAP SCREEN TO ENGAGE</div>
    </div>

    <div id="meet-container"></div>
    
    <div id="overlay"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const urlParams = new URLSearchParams(window.location.search);
        const roomName = urlParams.get('room') || 'COSMIC-UPLINK-' + Math.random().toString(36).substring(7);
        let api = null;

        // ==== THE MAGIC FUNCTION ====
        function initializeUplink() {
            // 1. Change text to show we are working
            const bootScreen = document.getElementById('boot-screen');
            const trigger = document.getElementById('interaction-trigger');
            
            trigger.style.display = 'none'; // Hide the button immediately
            document.querySelector('.glow-text').innerHTML = "> ESTABLISHING VIDEO LINK...<br>> PLEASE STAND BY...";

            // 2. Start Jitsi immediately
            startJitsi(bootScreen);
        }

        function startJitsi(bootScreenElement) {
            const domain = 'meet.jit.si';
            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet-container'),
                configOverwrite: {
                    prejoinPageEnabled: false,      // KILL THE LOBBY
                    startWithAudioMuted: false,     // AUDIO ON
                    startWithVideoMuted: false,     // VIDEO ON
                    disableDeepLinking: true,       // NO APP PROMPTS
                    requireDisplayName: false,
                    // REMOVE ALL BUTTONS for pure view
                    toolbarButtons: ['hangup', 'microphone', 'camera', 'tileview'], 
                },
                interfaceConfigOverwrite: {
                    // Hide everything possible
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    TOOLBAR_ALWAYS_VISIBLE: false,
                    filmStripOnly: false,
                    DEFAULT_REMOTE_DISPLAY_NAME: 'Target',
                },
                userInfo: { displayName: 'Ghost' }
            };

            api = new JitsiMeetExternalAPI(domain, options);

            // 3. LISTEN FOR CONNECTION
            api.addEventListeners({
                // ONLY remove the boot screen when the video is ACTUALLY ready
                videoConferenceJoined: function() {
                    console.log("Joined! Fading in...");
                    
                    // Fade out the boot screen
                    bootScreenElement.style.transition = "opacity 1s";
                    bootScreenElement.style.opacity = "0";
                    
                    // Fade in the video
                    document.getElementById('meet-container').style.opacity = "1";

                    // Remove boot screen from DOM after fade
                    setTimeout(() => {
                        bootScreenElement.style.display = 'none';
                    }, 1000);
                },
                
                // If call ends, close app
                videoConferenceLeft: function() {
                    tg.close();
                }
            });
        }
    </script>
</body>
</html>
