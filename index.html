<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cosmic Uplink</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background-color: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        
        /* The container for the video */
        #meet-container { width: 100%; height: 100%; transition: filter 0.5s; }
        
        /* The Cosmic Filter Class */
        .cosmic-filter { filter: sepia(20%) hue-rotate(180deg) saturate(120%) contrast(110%); }

        /* CRT Overlay lines */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%; z-index: 10; opacity: 0.7;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        
        #status { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: #0f0; padding: 8px 12px; border: 1px solid #0f0; border-radius: 4px; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }

        /* Controls that need pointer events */
        .controls { pointer-events: auto; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; }
        .btn { background: rgba(0, 20, 0, 0.8); border: 1px solid #0f0; color: #0f0; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-family: monospace; text-transform: uppercase; font-size: 12px; }
        .btn:active { background: #0f0; color: #000; }

        /* Start Screen */
        #start-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #0f0; }
        #start-btn { padding: 15px 30px; font-size: 18px; background: #000; border: 2px solid #0f0; color: #0f0; cursor: pointer; margin-top: 20px; box-shadow: 0 0 10px #0f0; animation: pulse 2s infinite; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 5px #0f0; } 50% { box-shadow: 0 0 20px #0f0; } 100% { box-shadow: 0 0 5px #0f0; } }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="text-shadow: 0 0 10px #0f0;">COSMIC UPLINK</h1>
        <p>SECURE CHANNEL DETECTED</p>
        <button id="start-btn" onclick="initCosmos()">ESTABLISH LINK</button>
    </div>

    <div id="status">WAITING FOR UPLINK...</div>
    <div id="meet-container" class="cosmic-filter"></div>
    <div id="overlay"></div>
    
    <div id="ui-layer">
        <div class="controls">
            <button class="btn" onclick="toggleFilters()">FX Toggle</button>
            <button class="btn" onclick="endSession()">Abort</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // Get Room ID from URL or generate random
        const urlParams = new URLSearchParams(window.location.search);
        // Using a more unique prefix to avoid collision in public Jitsi
        const roomName = urlParams.get('room') || 'COSMIC-' + (Math.random() + 1).toString(36).substring(7);
        
        let api = null;
        let sessionTimer = null;

        function updateStatus(text) {
            document.getElementById('status').innerText = text;
        }

        function toggleFilters() {
            const container = document.getElementById('meet-container');
            container.classList.toggle('cosmic-filter');
        }

        // ==== 1. INITIALIZE (Triggered by User Click) ====
        function initCosmos() {
            // Hide start screen
            document.getElementById('start-screen').style.display = 'none';
            updateStatus('üì° INITIALIZING SYSTEMS...');

            const domain = 'meet.jit.si';
            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet-container'),
                lang: 'en',
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    prejoinPageEnabled: false,
                    disableDeepLinking: true, 
                    // New location for toolbar config
                    toolbarButtons: [
                        'camera',
                        'microphone',
                        'tileview',
                        'fullscreen'
                    ],
                    // Hide other UI elements to look cleaner
                    notifications: [],
                },
                interfaceConfigOverwrite: {
                    // Legacy support, but mostly ignored now
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    DEFAULT_REMOTE_DISPLAY_NAME: 'COSMIC ENTITY',
                    TOOLBAR_ALWAYS_VISIBLE: false
                },
                userInfo: {
                    displayName: 'Cosmic Traveler'
                }
            };

            try {
                api = new JitsiMeetExternalAPI(domain, options);
                setupEventListeners();
            } catch (error) {
                console.error('Jitsi Error:', error);
                updateStatus('‚ùå SYSTEM FAILURE');
            }
        }

        // ==== 2. EVENT LISTENERS ====
        function setupEventListeners() {
            if (!api) return;

            api.addEventListeners({
                videoConferenceJoined: function() {
                    updateStatus('‚úÖ LINK ESTABLISHED');
                    startTimer(300); // 5 mins
                },
                participantJoined: function() {
                    updateStatus('‚ú® LIFEFORM DETECTED');
                },
                participantLeft: function() {
                    updateStatus('üí® SIGNAL LOST');
                },
                videoConferenceLeft: function() {
                    tg.close();
                }
            });
        }

        // ==== 3. UTILITIES ====
        function startTimer(duration) {
            let timer = duration, minutes, seconds;
            sessionTimer = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                updateStatus('‚è± ' + minutes + ":" + seconds);

                if (--timer < 0) {
                    endSession();
                }
            }, 1000);
        }

        function endSession() {
            clearInterval(sessionTimer);
            updateStatus('üõë TERMINATING...');
            if (api) api.dispose();
            setTimeout(() => tg.close(), 1000);
        }
    </script>
</body>
</html>
