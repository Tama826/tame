<!DOCTYPE html>
<html>
<head>
    <title>Video Call</title>
    <!-- Try multiple CDN sources for LiveKit -->
    <script src="https://unpkg.com/@livekit/components-js@latest/dist/livekit-components-js.umd.cjs"></script>
    <link rel="stylesheet" href="https://unpkg.com/@livekit/components-js@latest/dist/livekit-components-js.css">
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            font-family: Arial; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        h1 { text-align: center; }
        video { 
            width: 100%; 
            max-width: 800px; 
            border: 3px solid white;
            border-radius: 10px;
            display: block;
            margin: 20px auto;
        }
        .controls { text-align: center; margin: 20px; }
        button {
            padding: 12px 24px;
            margin: 10px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
        }
        #status {
            text-align: center;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
        }
        #debug {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üé• Video Call</h1>
    
    <div id="status">Loading...</div>
    
    <div id="video-container"></div>
    
    <div class="controls">
        <button onclick="startCamera()">Start Camera</button>
        <button onclick="connectToLiveKit()">Connect to LiveKit</button>
        <button onclick="stopCamera()">Stop Camera</button>
        <button onclick="testConnection()">Test Connection</button>
    </div>
    
    <div id="debug"></div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomName = urlParams.get('room');
        const token = urlParams.get('token');
        
        const statusEl = document.getElementById('status');
        const debugEl = document.getElementById('debug');
        const videoContainer = document.getElementById('video-container');
        
        let localStream = null;
        let room = null;
        
        // LiveKit server URL - YOUR SERVER
        const LIVEKIT_URL = 'wss://video-20qatdd3.livekit.cloud';
        
        // Log function
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugEl.innerHTML += logEntry + '<br>';
            console.log(logEntry);
        }
        
        // Update status
        function updateStatus(message, isError = false) {
            statusEl.innerHTML = message;
            statusEl.style.background = isError ? '#f44336' : '#4CAF50';
            log(message);
        }
        
        // Check if we have required parameters
        if (!roomName || !token) {
            updateStatus('‚ùå Missing room or token in URL!', true);
            debugEl.innerHTML = `Room: ${roomName || 'NOT FOUND'}<br>Token: ${token || 'NOT FOUND'}`;
        } else {
            updateStatus(`‚úÖ Room: ${roomName}<br>Token: ${token.substring(0, 30)}...`);
        }
        
        // Check if LiveKit SDK is loaded
        function checkLiveKitSDK() {
            if (typeof LiveKit !== 'undefined') {
                log('‚úÖ LiveKit SDK loaded (LiveKit object)');
                return true;
            }
            if (typeof LiveKitComponents !== 'undefined') {
                log('‚úÖ LiveKit Components SDK loaded');
                return true;
            }
            if (typeof window.livekit !== 'undefined') {
                log('‚úÖ LiveKit SDK loaded (window.livekit)');
                return true;
            }
            log('‚ùå LiveKit SDK not found in window');
            return false;
        }
        
        // Test WebSocket connection
        async function testWebSocket() {
            log('Testing WebSocket connection...');
            
            return new Promise((resolve) => {
                try {
                    const ws = new WebSocket(LIVEKIT_URL);
                    let connected = false;
                    
                    ws.onopen = () => {
                        connected = true;
                        log('‚úÖ WebSocket connection successful');
                        ws.close();
                        resolve(true);
                    };
                    
                    ws.onerror = (error) => {
                        log(`‚ùå WebSocket error: ${error.type}`);
                        resolve(false);
                    };
                    
                    ws.onclose = () => {
                        if (!connected) {
                            log('‚ùå WebSocket closed without opening');
                            resolve(false);
                        }
                    };
                    
                    // Timeout
                    setTimeout(() => {
                        if (!connected) {
                            log('‚ùå WebSocket connection timeout');
                            ws.close();
                            resolve(false);
                        }
                    }, 5000);
                    
                } catch (error) {
                    log(`‚ùå WebSocket exception: ${error.message}`);
                    resolve(false);
                }
            });
        }
        
        // Load LiveKit SDK dynamically
        function loadLiveKitSDK() {
            return new Promise((resolve) => {
                // Check if already loaded
                if (checkLiveKitSDK()) {
                    resolve(true);
                    return;
                }
                
                log('Loading LiveKit SDK...');
                
                // Try multiple CDNs
                const cdnSources = [
                    'https://cdn.jsdelivr.net/npm/@livekit/client-sdk@1.8.1/dist/livekit-client.umd.min.js',
                    'https://unpkg.com/@livekit/client-sdk@1.8.1/dist/livekit-client.umd.min.js',
                    'https://cdn.jsdelivr.net/npm/@livekit/client-sdk@1.5.5/dist/livekit-client.umd.min.js',
                    'https://unpkg.com/@livekit/client-sdk@1.5.5/dist/livekit-client.umd.min.js',
                    'https://cdn.jsdelivr.net/npm/@livekit/client-sdk@latest/dist/livekit-client.umd.min.js'
                ];
                
                let loaded = false;
                let attempts = 0;
                
                function tryNextCDN() {
                    if (loaded || attempts >= cdnSources.length) {
                        resolve(loaded);
                        return;
                    }
                    
                    const src = cdnSources[attempts];
                    attempts++;
                    log(`Trying CDN ${attempts}: ${src}`);
                    
                    const script = document.createElement('script');
                    script.src = src;
                    
                    script.onload = () => {
                        setTimeout(() => {
                            if (checkLiveKitSDK()) {
                                loaded = true;
                                log(`‚úÖ LiveKit SDK loaded from ${src}`);
                                resolve(true);
                            } else {
                                log(`‚ùå SDK loaded but not accessible`);
                                tryNextCDN();
                            }
                        }, 500);
                    };
                    
                    script.onerror = () => {
                        log(`‚ùå Failed to load from ${src}`);
                        tryNextCDN();
                    };
                    
                    document.head.appendChild(script);
                }
                
                tryNextCDN();
            });
        }
        
        // Start camera
        async function startCamera() {
            try {
                updateStatus('Starting camera...');
                
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                
                // Create video element
                const video = document.createElement('video');
                video.id = 'localVideo';
                video.autoplay = true;
                video.muted = true;
                video.playsInline = true;
                video.srcObject = localStream;
                video.style.width = '100%';
                video.style.maxWidth = '800px';
                video.style.border = '3px solid white';
                video.style.borderRadius = '10px';
                
                // Clear and add video
                videoContainer.innerHTML = '';
                videoContainer.appendChild(video);
                
                updateStatus('‚úÖ Camera started!');
                
            } catch (error) {
                updateStatus(`‚ùå Camera error: ${error.name}`, true);
                log(`Camera error details: ${error.message}`);
            }
        }
        
        // Stop camera
        function stopCamera() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
                const video = document.getElementById('localVideo');
                if (video) video.remove();
                updateStatus('Camera stopped');
            }
        }
        
        // Test connection
        async function testConnection() {
            updateStatus('Testing connection...');
            
            // Test WebSocket first
            const wsSuccess = await testWebSocket();
            if (!wsSuccess) {
                updateStatus('‚ùå Cannot connect to LiveKit server. Possible issues:', true);
                log('1. Server might be down');
                log('2. Firewall blocking WebSocket');
                log('3. Wrong server URL');
                log(`Current URL: ${LIVEKIT_URL}`);
                return;
            }
            
            // Test SDK loading
            const sdkSuccess = await loadLiveKitSDK();
            if (!sdkSuccess) {
                updateStatus('‚ùå Cannot load LiveKit SDK', true);
                log('Try refreshing the page or check internet connection');
                return;
            }
            
            updateStatus('‚úÖ All tests passed! Ready to connect.');
        }
        
        // Connect to LiveKit
        async function connectToLiveKit() {
            if (!roomName || !token) {
                updateStatus('‚ùå Missing room or token', true);
                return;
            }
            
            // Load SDK if not loaded
            const sdkLoaded = await loadLiveKitSDK();
            if (!sdkLoaded) {
                updateStatus('‚ùå LiveKit SDK not loaded', true);
                return;
            }
            
            updateStatus('Connecting to LiveKit...');
            
            try {
                // Different ways to access LiveKit based on SDK version
                let LiveKitClient;
                if (typeof window.LiveKitClient !== 'undefined') {
                    LiveKitClient = window.LiveKitClient;
                } else if (typeof window.livekit !== 'undefined' && window.livekit.Room) {
                    // For newer versions
                    room = new window.livekit.Room();
                } else if (typeof LiveKit !== 'undefined' && LiveKit.Room) {
                    // Alternative name
                    room = new LiveKit.Room();
                } else {
                    updateStatus('‚ùå Cannot find LiveKit Room class', true);
                    return;
                }
                
                // Create room using the appropriate method
                if (!room && LiveKitClient && LiveKitClient.Room) {
                    room = new LiveKitClient.Room();
                }
                
                if (!room) {
                    updateStatus('‚ùå Failed to create room instance', true);
                    return;
                }
                
                // Connect to room
                await room.connect(LIVEKIT_URL, token);
                
                updateStatus(`‚úÖ Connected to room: ${room.name}`);
                
                // Publish local tracks if available
                if (localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    const audioTrack = localStream.getAudioTracks()[0];
                    
                    if (videoTrack) {
                        await room.localParticipant.publishTrack(videoTrack);
                        log('‚úÖ Video published');
                    }
                    
                    if (audioTrack) {
                        await room.localParticipant.publishTrack(audioTrack);
                        log('‚úÖ Audio published');
                    }
                }
                
                // Listen for participants
                room.on('participantConnected', participant => {
                    log(`üë§ ${participant.identity} joined`);
                    updateStatus(`${participant.identity} joined the call!`);
                });
                
                updateStatus('üéâ Connected! Share the link with others.');
                
            } catch (error) {
                updateStatus(`‚ùå Connection failed: ${error.message}`, true);
                log(`Error details: ${error.stack}`);
                
                // Common error messages
                if (error.message.includes('JWT')) {
                    log('‚ö†Ô∏è Token error. Check if token is valid JWT');
                } else if (error.message.includes('WebSocket')) {
                    log('‚ö†Ô∏è WebSocket error. Server might be unreachable');
                } else if (error.message.includes('room')) {
                    log('‚ö†Ô∏è Room error. Token might not have room permissions');
                }
            }
        }
        
        // Auto-start on page load
        window.addEventListener('load', async () => {
            log('Page loaded');
            log(`Room: ${roomName}`);
            log(`Token length: ${token ? token.length : 0} chars`);
            log(`LiveKit URL: ${LIVEKIT_URL}`);
            
            if (roomName && token) {
                // Test connection automatically
                setTimeout(testConnection, 1000);
                // Start camera after 2 seconds
                setTimeout(startCamera, 2000);
            }
        });
    </script>
</body>
</html>
