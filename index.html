<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TAME Video Chat</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.9/dist/livekit-client.umd.min.js"></script>

<style>
    body {
        margin: 0;
        background: #000;
        color: #fff;
        font-family: sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    #status {
        padding: 10px;
        text-align: center;
        background: #111;
        font-size: 12px;
        color: #ffa; /* Yellow for visibility */
        white-space: pre-wrap; /* Wrap long error messages */
    }
    #videos {
        flex: 1;
        position: relative;
        background: #000;
    }
    video {
        object-fit: cover;
        background: #111;
    }
    /* Full screen remote */
    #remoteVideo {
        width: 100%;
        height: 100%;
    }
    /* PiP local */
    .local-wrapper {
        position: absolute;
        bottom: 90px;
        right: 20px;
        width: 100px;
        height: 140px;
        border: 2px solid #4CAF50;
        border-radius: 10px;
        overflow: hidden;
        z-index: 10;
        background: #000;
    }
    #localVideo {
        width: 100%;
        height: 100%;
        transform: scaleX(-1);
    }
    #controls {
        height: 80px;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        background: #111;
        padding-bottom: env(safe-area-inset-bottom);
    }
    button {
        padding: 12px 20px;
        border-radius: 25px;
        border: none;
        font-weight: bold;
        cursor: pointer;
    }
    .btn-blue { background: #2196F3; color: white; }
    .btn-red { background: #f44336; color: white; }
    .btn-gray { background: #444; color: white; }
    
    /* Modal */
    #permissionModal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
    .modal-content {
        background: #222;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        width: 80%;
    }
    #allowBtn {
        width: 100%;
        font-size: 18px;
        padding: 15px;
        margin-top: 20px;
    }
</style>
</head>

<body>

<div id="permissionModal">
    <div class="modal-content">
        <h3>Start Video Call</h3>
        <p>Tap below to join</p>
        <button id="allowBtn" class="btn-blue">Join Call</button>
    </div>
</div>

<div id="status">Ready.</div>

<div id="videos">
    <video id="remoteVideo" autoplay playsinline></video>
    <div class="local-wrapper">
        <video id="localVideo" autoplay muted playsinline></video>
    </div>
</div>

<div id="controls">
    <button id="micBtn" class="btn-gray">Mute</button>
    <button id="leaveBtn" class="btn-red">Leave</button>
</div>

<script>
    // 1. GLOBAL ERROR LOGGING (So you can see errors on phone)
    const statusEl = document.getElementById("status");
    function log(msg) {
        console.log(msg);
        statusEl.textContent = msg;
    }
    window.onerror = function(message, source, lineno, colno, error) {
        log("ERR: " + message);
    };

    // 2. CHECK IF LIVEKIT LOADED
    if (typeof LivekitClient === 'undefined') {
        log("CRITICAL: LiveKit library failed to load.");
    } else {
        log("Library loaded. Waiting for user...");
    }

    // 3. INIT TELEGRAM
    if (window.Telegram?.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    }

    let room;
    const modal = document.getElementById("permissionModal");
    const LIVEKIT_URL = "wss://video-20qatdd3.livekit.cloud"; // Your URL

    // 4. THE BUTTON CLICK (Logic decoupled to ensure it runs)
    document.getElementById("allowBtn").onclick = async function() {
        const btn = this;
        btn.disabled = true;
        btn.textContent = "Requesting...";
        
        try {
            // CHECK BROWSER SUPPORT
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error("Camera API not supported or insecure context (HTTP?)");
            }

            // A. TRIGGER PERMISSION
            log("Requesting Camera...");
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: true,
                video: { width: 320, height: 240, facingMode: 'user' }
            });
            
            // Stop tracks immediately (LiveKit will re-acquire them)
            stream.getTracks().forEach(t => t.stop());
            
            // B. HIDE MODAL & CONNECT
            modal.style.display = "none";
            connectToLiveKit();

        } catch (e) {
            log("PERM ERROR: " + e.message);
            btn.disabled = false;
            btn.textContent = "Try Again";
            alert("Error: " + e.message);
        }
    };

    async function connectToLiveKit() {
        const token = new URLSearchParams(location.search).get("token");
        if (!token) {
            log("ERROR: Token missing in URL");
            return;
        }

        log("Connecting to Room...");

        try {
            // Using Global LivekitClient (UMD)
            room = new LivekitClient.Room({
                adaptiveStream: true,
                dynacast: true
            });

            // HANDLE TRACKS
            room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
                const remoteEl = document.getElementById("remoteVideo");
                if (track.kind === "video") track.attach(remoteEl);
                if (track.kind === "audio") track.attach();
            });

            // CONNECT
            await room.connect(LIVEKIT_URL, token);
            log("Connected!");

            // PUBLISH LOCAL
            await room.localParticipant.enableCameraAndMicrophone();
            
            const localEl = document.getElementById("localVideo");
            const localTrack = Array.from(room.localParticipant.videoTrackPublications.values())[0]?.track;
            if (localTrack) localTrack.attach(localEl);

        } catch (e) {
            log("CONN ERROR: " + e.message);
            modal.style.display = "flex";
            document.getElementById("allowBtn").disabled = false;
            document.getElementById("allowBtn").textContent = "Retry";
        }
    }

    // CONTROLS
    document.getElementById("leaveBtn").onclick = () => {
        if (room) room.disconnect();
        Telegram.WebApp.close();
    };

    document.getElementById("micBtn").onclick = () => {
        if (!room) return;
        const isMuted = !room.localParticipant.isMicrophoneEnabled;
        room.localParticipant.setMicrophoneEnabled(isMuted);
        document.getElementById("micBtn").textContent = isMuted ? "Mute" : "Unmute";
    };

</script>
</body>
</html>
