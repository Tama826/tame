<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cosmic Uplink v3.1</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='https://meet.jit.si/external_api.js'></script>
    <style>
        /* RESET & GLOBAL */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body, html { 
            width: 100%; 
            height: 100%; 
            background: #000;
            overflow: hidden;
            font-family: 'Courier New', monospace, -apple-system, sans-serif;
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* MAIN CONTAINERS */
        #meet-container, #boot-screen, #permission-screen, #loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* PERMISSION REQUEST SCREEN */
        #permission-screen {
            background: #000;
            z-index: 1100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #0f0;
            text-align: center;
        }
        
        #permission-screen.active {
            display: flex;
        }
        
        .permission-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        /* LOADING SCREEN */
        #loading-screen {
            background: #000;
            z-index: 1050;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0f0;
            text-align: center;
        }
        
        #loading-screen.active {
            display: flex;
        }
        
        /* BOOT SCREEN */
        #boot-screen {
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0f0;
            padding: 20px;
            text-align: center;
        }
        
        /* MEET CONTAINER */
        #meet-container { 
            opacity: 0;
            transition: opacity 1s ease;
            filter: sepia(30%) hue-rotate(190deg) contrast(120%) saturate(110%);
        }
        
        #meet-container.active {
            opacity: 1;
        }
        
        /* OVERLAYS */
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                linear-gradient(90deg, rgba(255, 0, 0, 0.04), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.04));
            background-size: 100% 4px, 4px 100%;
            z-index: 999;
            opacity: 0.5;
            mix-blend-mode: overlay;
        }
        
        /* STATUS BAR */
        #status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 20, 0, 0.8);
            color: #0f0;
            padding: 10px 15px;
            font-size: 12px;
            z-index: 1001;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }
        
        /* TYPOGRAPHY */
        .glow-text {
            text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
        }
        
        /* BUTTONS */
        .cyber-btn {
            background: rgba(0, 255, 0, 0.1);
            border: 1px solid #0f0;
            color: #0f0;
            padding: 15px 30px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            text-transform: uppercase;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            min-width: 200px;
            text-align: center;
        }
        
        .cyber-btn:hover {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        
        .cyber-btn:active {
            transform: scale(0.95);
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
        }
        
        /* LOADER */
        .loader {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 0, 0.3);
            border-top: 3px solid #0f0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* DEBUG INFO (Hidden by default) */
        #debug-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: rgba(0, 255, 0, 0.3);
            font-size: 10px;
            z-index: 1001;
        }
        
        /* SAFE AREA ADJUSTMENTS */
        @supports (padding: max(0px)) {
            #status-bar {
                padding-top: max(10px, env(safe-area-inset-top));
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
            }
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div id="status-bar">
        <span id="status-text">> COSMIC UPLINK v3.1</span>
        <span id="room-display"></span>
    </div>
    
    <!-- Permission Screen -->
    <div id="permission-screen">
        <div class="permission-icon">ðŸŽ¤ðŸ“¹</div>
        <div class="glow-text">
            > PERMISSION REQUIRED<br>
            > CAMERA & MICROPHONE ACCESS<br>
            > REQUIRED FOR COSMIC UPLINK<br>
            <br>
            > TAP "ALLOW" WHEN PROMPTED<br>
            > DO NOT BLOCK PERMISSIONS
        </div>
        <div class="btn-group">
            <button class="cyber-btn" onclick="requestPermissions()">GRANT PERMISSIONS</button>
            <button class="cyber-btn" onclick="skipToCall()">CONTINUE WITHOUT MEDIA</button>
        </div>
        <div style="margin-top: 20px; font-size: 12px; opacity: 0.7;">
            Note: Some browsers require manual permission grant
        </div>
    </div>
    
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div class="glow-text" id="loading-text">
            > INITIALIZING COSMIC LINK...
        </div>
    </div>
    
    <!-- Boot Screen -->
    <div id="boot-screen">
        <div class="glow-text">
            > COSMIC UPLINK v3.1<br>
            > MOBILE OPTIMIZED<br>
            > SYSTEM CHECK... OK<br>
            > ENCRYPTION... READY<br>
            > FIREWALL BYPASS... ACTIVE<br>
            <br>
            <span class="blink">> AWAITING INITIATION</span>
        </div>
        <div class="btn-group">
            <button class="cyber-btn" onclick="startConnection()">INITIATE UPLINK</button>
        </div>
        <div style="margin-top: 30px; font-size: 11px; opacity: 0.5;">
            Auto-start in <span id="countdown">5</span> seconds
        </div>
    </div>
    
    <!-- Main Container -->
    <div id="meet-container"></div>
    <div id="overlay"></div>
    <div id="debug-info"></div>

    <script>
        // ======================
        // INITIALIZATION
        // ======================
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.BackButton.hide();
        
        // Detect environment
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        
        // State variables
        let api = null;
        let connectionAttempts = 0;
        let hasPermissions = false;
        let isConnecting = false;
        let autoStartTimer = null;
        let countdown = 5;
        
        // User info
        const user = tg.initDataUnsafe?.user;
        const username = user?.username || `user_${Math.floor(Math.random() * 10000)}`;
        const firstName = user?.first_name || 'CosmicTraveler';
        
        // Room info
        const urlParams = new URLSearchParams(window.location.search);
        const roomName = urlParams.get('room') || `COSMIC-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
        document.getElementById('room-display').textContent = `ROOM: ${roomName}`;
        
        // Debug info
        document.getElementById('debug-info').textContent = 
            `Mobile: ${isMobile ? 'Yes' : 'No'} | iOS: ${isIOS ? 'Yes' : 'No'} | Safari: ${isSafari ? 'Yes' : 'No'}`;
        
        // ======================
        // COUNTDOWN TIMER
        // ======================
        function startCountdown() {
            const countdownEl = document.getElementById('countdown');
            autoStartTimer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(autoStartTimer);
                    startConnection();
                }
            }, 1000);
        }
        
        // Start countdown on load
        window.addEventListener('load', () => {
            startCountdown();
        });
        
        // ======================
        // START CONNECTION FLOW
        // ======================
        function startConnection() {
            clearInterval(autoStartTimer);
            
            if (isConnecting) return;
            isConnecting = true;
            
            document.getElementById('status-text').textContent = "> INITIATING CONNECTION...";
            
            // Show permission screen first
            showPermissionScreen();
        }
        
        // ======================
        // PERMISSION HANDLING
        // ======================
        function showPermissionScreen() {
            document.getElementById('boot-screen').style.display = 'none';
            document.getElementById('permission-screen').classList.add('active');
        }
        
        async function requestPermissions() {
            document.getElementById('status-text').textContent = "> REQUESTING PERMISSIONS...";
            
            try {
                // Request camera permission first (most restrictive)
                const cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 24 }
                    },
                    audio: false 
                });
                
                // Stop camera stream immediately (we just wanted permission)
                cameraStream.getTracks().forEach(track => track.stop());
                
                // Request microphone
                const micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    },
                    video: false 
                });
                
                // Stop mic stream
                micStream.getTracks().forEach(track => track.stop());
                
                hasPermissions = true;
                document.getElementById('status-text').textContent = "> PERMISSIONS GRANTED";
                
                // Proceed to load Jitsi
                setTimeout(() => {
                    document.getElementById('permission-screen').classList.remove('active');
                    loadJitsiMeeting();
                }, 500);
                
            } catch (error) {
                console.error('Permission error:', error);
                
                // Handle specific errors
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    document.getElementById('status-text').textContent = "> PERMISSION DENIED";
                    alert("Please allow camera and microphone access in your browser settings, then refresh the page.");
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    document.getElementById('status-text').textContent = "> NO DEVICES FOUND";
                    alert("No camera or microphone found. Please connect a device.");
                } else {
                    document.getElementById('status-text').textContent = "> PERMISSION ERROR";
                }
                
                // Still try to load without permissions
                setTimeout(() => {
                    document.getElementById('permission-screen').classList.remove('active');
                    loadJitsiMeeting();
                }, 1000);
            }
        }
        
        function skipToCall() {
            document.getElementById('status-text').textContent = "> SKIPPING PERMISSIONS...";
            document.getElementById('permission-screen').classList.remove('active');
            hasPermissions = false;
            setTimeout(loadJitsiMeeting, 500);
        }
        
        // ======================
        // JITSI LOADING
        // ======================
        function loadJitsiMeeting() {
            document.getElementById('loading-screen').classList.add('active');
            document.getElementById('loading-text').textContent = "> LOADING COSMIC INTERFACE...";
            
            // Wait a moment for DOM updates
            setTimeout(() => {
                initializeJitsi();
            }, 1000);
        }
        
        function initializeJitsi() {
            document.getElementById('loading-text').textContent = "> CONNECTING TO SERVER...";
            
            // Jitsi configuration with mobile optimizations
            const domain = 'meet.jit.si';
            const options = {
                roomName: roomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#meet-container'),
                configOverwrite: {
                    // Critical: Disable prejoin page to avoid permission loops
                    prejoinPageEnabled: false,
                    disableDeepLinking: true,
                    requireDisplayName: false,
                    enableWelcomePage: false,
                    enableClosePage: false,
                    
                    // Start muted to avoid permission issues
                    startWithAudioMuted: !hasPermissions,
                    startWithVideoMuted: !hasPermissions,
                    
                    // Optimize for mobile
                    resolution: isMobile ? 360 : 720,
                    constraints: {
                        video: {
                            height: {
                                ideal: isMobile ? 360 : 720,
                                max: isMobile ? 720 : 1080,
                                min: 180
                            }
                        }
                    },
                    
                    // Disable features that cause permission prompts
                    disableSimulcast: isMobile,
                    enableLayerSuspension: true,
                    p2p: { enabled: false }, // Disable P2P for better reliability
                    
                    // Toolbar settings
                    toolbarButtons: [
                        'microphone', 'camera', 'desktop', 'fullscreen',
                        'hangup', 'settings', 'videoquality', 'filmstrip'
                    ],
                    
                    // Disable chat completely
                    disableChat: true,
                    disableInviteFunctions: true,
                    
                    // Set user info
                    defaultLocalDisplayName: firstName
                },
                interfaceConfigOverwrite: {
                    // Hide unnecessary elements
                    SHOW_JITSI_WATERMARK: false,
                    SHOW_WATERMARK_FOR_GUESTS: false,
                    SHOW_POWERED_BY: false,
                    
                    // Mobile optimizations
                    MOBILE_APP_PROMO: false,
                    VERTICAL_FILMSTRIP: isMobile,
                    TILE_VIEW_MAX_COLUMNS: isMobile ? 2 : 4,
                    
                    // Simplify interface
                    TOOLBAR_ALWAYS_VISIBLE: false,
                    SETTINGS_SECTIONS: ['devices', 'language'],
                    
                    // Disable features
                    DISABLE_VIDEO_BACKGROUND: true,
                    DISABLE_FOCUS_INDICATOR: isMobile,
                    
                    // Avatar settings
                    DEFAULT_REMOTE_DISPLAY_NAME: 'âˆ™âˆ™âˆ™',
                    DEFAULT_LOCAL_DISPLAY_NAME: firstName
                },
                userInfo: {
                    displayName: firstName,
                    email: `${username}@cosmic.uplink`
                },
                onload: function() {
                    console.log('Jitsi Meet API loaded');
                    document.getElementById('loading-text').textContent = "> API LOADED, STARTING...";
                }
            };
            
            // Create Jitsi instance
            try {
                api = new JitsiMeetExternalAPI(domain, options);
                setupEventListeners();
            } catch (error) {
                console.error('Jitsi initialization error:', error);
                document.getElementById('loading-text').textContent = "> INITIALIZATION FAILED";
                
                // Try again with simpler config
                setTimeout(() => {
                    if (connectionAttempts < 2) {
                        connectionAttempts++;
                        document.getElementById('loading-text').textContent = `> RETRYING (${connectionAttempts}/2)...`;
                        initializeJitsi();
                    } else {
                        document.getElementById('loading-text').textContent = "> FAILED TO LOAD";
                        alert("Could not load video call. Please refresh the page.");
                    }
                }, 2000);
            }
        }
        
        // ======================
        // EVENT HANDLERS
        // ======================
        function setupEventListeners() {
            if (!api) return;
            
            // Main event: Conference joined
            api.on('videoConferenceJoined', () => {
                console.log('Conference joined');
                document.getElementById('status-text').textContent = "> CONNECTION SECURE";
                
                // Hide loading screen
                document.getElementById('loading-screen').classList.remove('active');
                
                // Show meeting container
                document.getElementById('meet-container').classList.add('active');
                
                // Update status
                setTimeout(() => {
                    document.getElementById('status-text').textContent = "> COSMIC UPLINK ACTIVE";
                }, 1000);
                
                // Force show video if permissions were granted
                if (hasPermissions) {
                    setTimeout(() => {
                        try {
                            api.executeCommand('toggleVideo');
                            setTimeout(() => api.executeCommand('toggleVideo'), 100);
                        } catch (e) {
                            // Ignore errors
                        }
                    }, 500);
                }
            });
            
            // Connection established
            api.on('connectionEstablished', () => {
                console.log('Connection established');
                document.getElementById('loading-text').textContent = "> AUTHENTICATING...";
            });
            
            // Participant joined
            api.on('participantJoined', () => {
                document.getElementById('status-text').textContent = "> USER DETECTED";
            });
            
            // Participant left
            api.on('participantLeft', () => {
                document.getElementById('status-text').textContent = "> USER DISCONNECTED";
            });
            
            // Conference left
            api.on('videoConferenceLeft', () => {
                document.getElementById('status-text').textContent = "> CONNECTION TERMINATED";
                setTimeout(() => tg.close(), 2000);
            });
            
            // Ready to close
            api.on('readyToClose', () => {
                tg.close();
            });
            
            // Error handling
            api.on('error', (error) => {
                console.error('Jitsi error:', error);
                document.getElementById('loading-text').textContent = "> ERROR DETECTED";
                
                // Try to recover
                setTimeout(() => {
                    if (api) {
                        api.dispose();
                        api = null;
                    }
                    loadJitsiMeeting();
                }, 3000);
            });
            
            // Check if conference doesn't start within 10 seconds
            setTimeout(() => {
                const meetContainer = document.getElementById('meet-container');
                if (!meetContainer.classList.contains('active')) {
                    console.log('Forcing conference start...');
                    document.getElementById('loading-screen').classList.remove('active');
                    meetContainer.classList.add('active');
                    document.getElementById('status-text').textContent = "> MANUAL OVERRIDE ACTIVE";
                    
                    // Try to join again
                    setTimeout(() => {
                        if (api) {
                            try {
                                api.executeCommand('subject', 'Cosmic Uplink');
                            } catch (e) {
                                // Ignore
                            }
                        }
                    }, 1000);
                }
            }, 10000);
        }
        
        // ======================
        // BROWSER COMPATIBILITY
        // ======================
        
        // Handle browser-specific issues
        if (isIOS) {
            // iOS Safari needs special handling
            document.addEventListener('touchstart', () => {
                // iOS requires user interaction before playing video
                if (api && !hasPermissions) {
                    setTimeout(() => {
                        try {
                            api.executeCommand('toggleAudio');
                            api.executeCommand('toggleVideo');
                        } catch (e) {
                            // Ignore errors
                        }
                    }, 1000);
                }
            }, { once: true });
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                document.getElementById('status-text').textContent = "> CONNECTION SUSPENDED";
            } else {
                document.getElementById('status-text').textContent = "> CONNECTION RESTORED";
            }
        });
        
        // Handle beforeunload
        window.addEventListener('beforeunload', (e) => {
            if (api) {
                e.preventDefault();
                e.returnValue = '';
                api.dispose();
            }
        });
        
        // Telegram back button
        tg.BackButton.onClick(() => {
            if (api) {
                api.executeCommand('hangup');
            }
            tg.close();
        });
        
        // Force start if nothing happens in 30 seconds
        setTimeout(() => {
            const loadingScreen = document.getElementById('loading-screen');
            const meetContainer = document.getElementById('meet-container');
            
            if (loadingScreen.classList.contains('active')) {
                loadingScreen.classList.remove('active');
                meetContainer.classList.add('active');
                document.getElementById('status-text').textContent = "> AUTOMATIC START";
                
                // Try to inject manual start
                if (api) {
                    try {
                        api.executeCommand('subject', 'Cosmic Uplink - Auto Start');
                    } catch (e) {
                        console.log('Auto start command failed');
                    }
                }
            }
        }, 30000);
        
        // Debug: Log all Jitsi events
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type) {
                console.log('Jitsi message:', event.data.type);
            }
        });
    </script>
</body>
</html>
