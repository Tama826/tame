<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>TAME Video Chat</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.9/dist/livekit-client.umd.min.js"></script>

<style>
    /* --- RESET & BASE --- */
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
        margin: 0;
        background: #000;
        color: #fff;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        height: 100vh;
        height: 100dvh; /* Mobile viewport fix */
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* --- MAIN VIDEO CONTAINER --- */
    #app-container {
        position: relative;
        flex: 1;
        width: 100%;
        background: #111;
        overflow: hidden;
    }

    /* Remote Video - Full Screen Background */
    #remoteVideoWrapper {
        position: absolute;
        inset: 0;
        z-index: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    #remoteVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    /* Placeholder when no remote video yet */
    .placeholder-text {
        position: absolute;
        color: rgba(255,255,255,0.3);
        font-size: 18px;
        z-index: -1;
    }

    /* Local Video - Floating PiP */
    #localVideoWrapper {
        position: absolute;
        bottom: 100px; /* Space for controls */
        right: 16px;
        width: 90px;
        height: 135px; /* ~2:3 aspect ratio */
        border-radius: 12px;
        border: 2px solid rgba(255,255,255,0.2);
        overflow: hidden;
        z-index: 10;
        background: #222;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    #localVideo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1); /* Mirror local view */
    }

    /* --- CONTROLS OVERLAY --- */
    #controls-overlay {
        position: absolute;
        bottom: 30px;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        gap: 20px;
        z-index: 20;
        padding-bottom: env(safe-area-inset-bottom);
    }
    .control-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        transition: transform 0.1s;
    }
    .control-btn:active { transform: scale(0.95); }
    
    /* Icons (using text for simplicity, replace with SVGs if needed) */
    .icon-mic::after { content: 'ðŸŽ¤'; font-size: 24px; }
    .icon-cam::after { content: 'ðŸ“·'; font-size: 24px; }
    .icon-leave::after { content: 'ðŸ“ž'; font-size: 24px; color: white; transform: rotate(135deg); }

    .btn-normal { background: rgba(255,255,255,0.9); color: #000; }
    .btn-muted { background: rgba(255,255,255,0.3); color: #fff; position: relative; }
    /* Strike-through for muted state */
    .btn-muted::before { content: ''; position: absolute; width: 70%; height: 2px; background: #fff; transform: rotate(-45deg); }
    .btn-leave { background: #ff3b30; }

    /* --- STATUS & FOOTER --- */
    #status-bar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 8px;
        padding-top: max(8px, env(safe-area-inset-top));
        text-align: center;
        font-size: 13px;
        color: rgba(255,255,255,0.7);
        background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        z-index: 15;
        pointer-events: none;
    }
    #footer {
        position: absolute;
        bottom: 5px;
        width: 100%;
        text-align: center;
        font-size: 10px;
        color: rgba(255,255,255,0.4);
        z-index: 5;
        padding-bottom: env(safe-area-inset-bottom);
    }

    /* --- MODAL --- */
    #permissionModal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
    }
    .modal-content {
        background: #1c1c1e;
        padding: 32px 24px;
        border-radius: 20px;
        text-align: center;
        width: 85%;
        max-width: 320px;
    }
    .modal-content h3 { margin: 0 0 12px 0; font-weight: 600; }
    .modal-content p { color: #aaa; margin-bottom: 24px; font-size: 15px; }
    #joinBtn {
        width: 100%;
        padding: 16px;
        border-radius: 14px;
        border: none;
        background: #0A84FF;
        color: white;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
    }
    #joinBtn:disabled { opacity: 0.5; }
</style>
</head>

<body>

<div id="permissionModal">
    <div class="modal-content">
        <h3>Ready to join?</h3>
        <p>We need access to your camera and microphone.</p>
        <button id="joinBtn">Join Call</button>
    </div>
</div>

<div id="app-container">
    <div id="status-bar">Initializing...</div>

    <div id="remoteVideoWrapper">
        <div class="placeholder-text">Waiting for others...</div>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>
    
    <div id="localVideoWrapper">
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <div id="controls-overlay">
        <button id="micBtn" class="control-btn btn-normal icon-mic"></button>
        <button id="leaveBtn" class="control-btn btn-leave icon-leave"></button>
        <button id="camBtn" class="control-btn btn-normal icon-cam"></button>
    </div>

    <div id="footer">Developed by TAME</div>
</div>


<script>
    // ==============================
    // 1. SETUP & HELPERS
    // ==============================
    const statusEl = document.getElementById("status-bar");
    const modal = document.getElementById("permissionModal");
    const joinBtn = document.getElementById("joinBtn");
    
    // Robust Error Logging to UI
    function log(msg, isError = false) {
        console.log(msg);
        statusEl.textContent = msg;
        if (isError) statusEl.style.color = '#ff3b30';
        else statusEl.style.color = 'rgba(255,255,255,0.7)';
    }
    window.onerror = (msg) => log("Err: " + msg, true);

    // Initialize Telegram
    if (window.Telegram?.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        Telegram.WebApp.enableClosingConfirmation();
    }

    // Config
    const LIVEKIT_URL = "wss://video-20qatdd3.livekit.cloud";
    let room;
    let micOn = true;
    let camOn = true;

    // ==============================
    // 2. PERMISSION GESTURE (The crucial part that is working)
    // ==============================
    joinBtn.onclick = async function() {
        joinBtn.disabled = true;
        joinBtn.textContent = "Connecting...";
        log("Requesting permissions...");
        
        try {
            // 1. Trigger gesture requirement
            const stream = await navigator.mediaDevices.getUserMedia({
                audio: true,
                // Low-bandwidth constraints
                video: { width: { ideal: 320 }, height: { ideal: 240 }, facingMode: 'user' }
            });
            // 2. Release immediately
            stream.getTracks().forEach(t => t.stop());
            
            // 3. Proceed
            modal.style.display = "none";
            connectToLiveKit();

        } catch (e) {
            log("Permission denied. Please allow access.", true);
            joinBtn.disabled = false;
            joinBtn.textContent = "Try Again";
            alert("Camera/Mic access denied. Please check browser settings.");
        }
    };

    // ==============================
    // 3. CONNECTION & VIDEO HANDLING (Fixed logic here)
    // ==============================
    async function connectToLiveKit() {
        const token = new URLSearchParams(location.search).get("token");
        if (!token) { log("Error: Missing token URL parameter", true); return; }

        log("Connecting to server...");

        try {
            // Init Client
            room = new LivekitClient.Room({
                adaptiveStream: true,
                dynacast: true,
                videoCaptureDefaults: {
                    resolution: LivekitClient.VideoPresets.h360.resolution
                },
                 publishDefaults: {
                    videoCodec: 'vp8',
                    dtx: true, // Saves audio bandwidth when silent
                }
            });

            // --- EVENT HANDLERS FOR VIDEO ATTACHMENT ---

            // Handle Remote Video Joining
            room.on(LivekitClient.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                log(`Linked with ${participant.identity}`);
                if (track.kind === "video") {
                    const remoteEl = document.getElementById("remoteVideo");
                    track.attach(remoteEl);
                    // Ensure visibility in case CSS hid it previously
                    remoteEl.style.display = 'block'; 
                }
                if (track.kind === "audio") {
                    track.attach(); // Auto-creates hidden audio el
                }
            });

            // Handle Remote Video Leaving/Muting
             room.on(LivekitClient.RoomEvent.TrackUnsubscribed, (track, publication) => {
                 track.detach();
                 if (track.kind === 'video') {
                     // Optional: Show placeholder again if needed
                 }
             });

            // Handle Local Video Publishing (The fix for local video)
            room.on(LivekitClient.RoomEvent.LocalTrackPublished, (publication) => {
                if (publication.kind === 'video') {
                    log("Local video active");
                    const localEl = document.getElementById("localVideo");
                    publication.track.attach(localEl);
                }
            });

            // Handle Connection States
            room.on(LivekitClient.RoomEvent.ConnectionStateChanged, (state) => {
                if (state === 'connected') log("Connected");
                if (state === 'reconnecting') log("Reconnecting (weak signal)...");
                if (state === 'disconnected') handleLeave();
            });


            // --- CONNECT & PUBLISH ---
            await room.connect(LIVEKIT_URL, token);
            
            // This triggers the LocalTrackPublished event above
            log("Publishing tracks...");
            await room.localParticipant.enableCameraAndMicrophone();

        } catch (e) {
            log("Connection Failed: " + e.message, true);
            modal.style.display = "flex";
            joinBtn.disabled = false;
            joinBtn.textContent = "Retry Connection";
        }
    }

    // ==============================
    // 4. CONTROLS UI
    // ==============================
    const micBtn = document.getElementById("micBtn");
    const camBtn = document.getElementById("camBtn");

    function updateControlStates() {
        micBtn.className = micOn ? "control-btn btn-normal icon-mic" : "control-btn btn-muted icon-mic";
        camBtn.className = camOn ? "control-btn btn-normal icon-cam" : "control-btn btn-muted icon-cam";
    }

    micBtn.onclick = async () => {
        if (!room) return;
        micOn = !micOn;
        await room.localParticipant.setMicrophoneEnabled(micOn);
        updateControlStates();
    };

    camBtn.onclick = async () => {
        if (!room) return;
        camOn = !camOn;
        await room.localParticipant.setCameraEnabled(camOn);
        updateControlStates();
    };

    document.getElementById("leaveBtn").onclick = () => handleLeave();

    function handleLeave() {
        if (room) room.disconnect();
        if (window.Telegram?.WebApp) Telegram.WebApp.close();
        else window.location.reload();
    }
</script>
</body>
</html>
