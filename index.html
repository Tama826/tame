<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>TAME Video Chat</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/livekit-client@2.5.9/dist/livekit-client.umd.min.js"></script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

<style>
/* YOUR ORIGINAL STYLES â€” UNCHANGED */
* { box-sizing:border-box; margin:0; padding:0; }
body {
    background:#000; color:#fff; height:100vh; overflow:hidden;
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
}
#app-container { position:relative; height:100%; }
#remoteVideoWrapper { position:absolute; inset:0; background:#000; }
#remoteVideo { width:100%; height:100%; object-fit:cover; }
.placeholder-text {
    position:absolute; inset:0; display:flex;
    align-items:center; justify-content:center;
    color:#777; font-size:18px;
}
#localVideoWrapper {
    position:absolute; bottom:100px; right:16px;
    width:100px; height:150px;
    border-radius:12px; overflow:hidden;
    border:2px solid rgba(255,255,255,.3);
}
#localVideo {
    width:100%; height:100%; object-fit:cover;
    transform:scaleX(-1);
}
#controls-overlay {
    position:absolute; bottom:30px; left:0; right:0;
    display:flex; justify-content:center; gap:24px;
}
.control-btn {
    width:60px; height:60px; border-radius:50%;
    border:none; font-size:26px;
}
#permissionModal {
    position:fixed; inset:0; background:#000;
    display:flex; align-items:center; justify-content:center;
    z-index:100;
}
.modal-content {
    background:#1c1c1e; padding:24px;
    border-radius:16px; text-align:center;
}
#joinBtn {
    width:100%; padding:16px;
    font-size:18px; background:#0A84FF;
    color:white; border:none; border-radius:12px;
}
</style>
</head>

<body>

<div id="permissionModal">
    <div class="modal-content">
        <h3>Video Call</h3>
        <p>Allow camera & microphone</p>
        <button id="joinBtn">Join Call</button>
    </div>
</div>

<div id="app-container">
    <div id="remoteVideoWrapper">
        <div class="placeholder-text">Waiting for participantâ€¦</div>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="localVideoWrapper">
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <div id="controls-overlay">
        <button id="micBtn" class="control-btn">ðŸŽ¤</button>
        <button id="leaveBtn" class="control-btn">ðŸ“ž</button>
        <button id="camBtn" class="control-btn">ðŸ“·</button>
    </div>
</div>

<script>
const joinBtn = document.getElementById("joinBtn");
const modal = document.getElementById("permissionModal");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const placeholder = document.querySelector(".placeholder-text");

const LIVEKIT_URL = "wss://video-20qatdd3.livekit.cloud";

let room;
let micEnabled = true;
let camEnabled = true;
let connecting = false;

/* =========================
   PERMISSION BUTTON â€” FIXED
   ========================= */
joinBtn.onclick = async () => {
    if (connecting) return;
    connecting = true;
    joinBtn.disabled = true;

    try {
        // Permission ONLY (no publishing)
        const temp = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
        temp.getTracks().forEach(t => t.stop());

        modal.style.display = "none";
        await connectLiveKit();

    } catch (e) {
        joinBtn.disabled = false;
        connecting = false;
        alert("Permission required");
    }
};

/* =========================
   LIVEKIT CONNECTION
   ========================= */
async function connectLiveKit() {
    const token = new URLSearchParams(location.search).get("token");
    if (!token) return alert("Missing token");

    room = new LivekitClient.Room({
        adaptiveStream:true,
        dynacast:true,
        publishDefaults:{
            videoEncoding:{ maxBitrate:300000, maxFramerate:15 }
        }
    });

    /* LOCAL TRACK ATTACH (NO ECHO) */
    room.on(LivekitClient.RoomEvent.LocalTrackPublished, pub => {
        if (pub.kind === "video") {
            pub.track.attach(localVideo);
            localVideo.muted = true;
        }
    });

    /* REMOTE TRACKS */
    room.on(LivekitClient.RoomEvent.TrackSubscribed, (track) => {
        if (track.kind === "video") {
            placeholder.style.display = "none";
            track.attach(remoteVideo);
            remoteVideo.muted = false;
        }
        if (track.kind === "audio") {
            const audio = document.createElement("audio");
            audio.autoplay = true;
            audio.playsInline = true;
            track.attach(audio);
            document.body.appendChild(audio);
        }
    });

    room.on(LivekitClient.RoomEvent.ParticipantDisconnected, () => {
        placeholder.style.display = "flex";
    });

    await room.connect(LIVEKIT_URL, token);

    // LET LIVEKIT OWN MEDIA (CRITICAL FIX)
    await room.localParticipant.setCameraEnabled(true);
    await room.localParticipant.setMicrophoneEnabled(true);
}

/* =========================
   CONTROLS
   ========================= */
document.getElementById("micBtn").onclick = async () => {
    micEnabled = !micEnabled;
    await room.localParticipant.setMicrophoneEnabled(micEnabled);
};

document.getElementById("camBtn").onclick = async () => {
    camEnabled = !camEnabled;
    await room.localParticipant.setCameraEnabled(camEnabled);
};

document.getElementById("leaveBtn").onclick = () => {
    room?.disconnect();
    location.reload();
};

/* TELEGRAM */
if (window.Telegram?.WebApp) {
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
}
</script>
</body>
</html>
