<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telegram Video Call</title>

<!-- LIVEKIT UMD (CRITICAL) -->
<script src="https://unpkg.com/livekit-client@1.15.6/dist/livekit-client.umd.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  height: 100%;
  font-family: Arial, sans-serif;
}

#permissionModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.modal {
  background: #222;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
}

.modal button {
  padding: 12px 30px;
  border-radius: 25px;
  background: #4CAF50;
  border: none;
  color: #fff;
  font-size: 16px;
}

#status {
  text-align: center;
  padding: 8px;
  background: #111;
}

#videos {
  display: flex;
  height: calc(100% - 100px);
  justify-content: center;
  align-items: center;
  gap: 10px;
}

video {
  background: #111;
  border-radius: 10px;
  object-fit: cover;
}

#remoteVideo {
  width: 70%;
  border: 2px solid #2196F3;
}

#localVideo {
  width: 25%;
  border: 2px solid #4CAF50;
  transform: scaleX(-1);
}

#controls {
  display: flex;
  justify-content: center;
  gap: 10px;
  padding: 10px;
}
button {
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
}
</style>
</head>

<body>

<div id="permissionModal">
  <div class="modal">
    <h3>Camera & Microphone</h3>
    <p>Tap Allow to start</p>
    <!-- INLINE HANDLER (TELEGRAM SAFE) -->
    <button onclick="requestPermission()">Allow</button>
  </div>
</div>

<div id="status">Waiting for permissionâ€¦</div>

<div id="videos">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>
</div>

<div id="controls">
  <button onclick="toggleMic()">Mic</button>
  <button onclick="toggleCam()">Cam</button>
  <button onclick="leave()">Leave</button>
</div>

<script>
const LIVEKIT_URL = "wss://video-20qatdd3.livekit.cloud";
let room;
let micOn = true;
let camOn = true;

/* TELEGRAM FIX */
if (window.Telegram?.WebApp) {
  Telegram.WebApp.expand();
}

function getToken() {
  return new URLSearchParams(location.search).get("token");
}

/* ===== PERMISSION (GUARANTEED TO FIRE) ===== */
async function requestPermission() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: true,
      video: true
    });

    document.getElementById("localVideo").srcObject = stream;
    stream.getTracks().forEach(t => t.stop());

    document.getElementById("permissionModal").style.display = "none";
    startCall();
  } catch (e) {
    document.getElementById("status").innerText = "Permission denied";
  }
}

/* ===== LIVEKIT ===== */
async function startCall() {
  const token = getToken();
  if (!token) {
    document.getElementById("status").innerText = "No token";
    return;
  }

  room = new LivekitClient.Room({
    adaptiveStream: true,
    dynacast: true
  });

  room.on(LivekitClient.RoomEvent.TrackSubscribed, track => {
    if (track.kind === "video") {
      track.attach(document.getElementById("remoteVideo"));
    }
    if (track.kind === "audio") {
      const a = document.createElement("audio");
      a.autoplay = true;
      track.attach(a);
      document.body.appendChild(a);
    }
  });

  await room.connect(LIVEKIT_URL, token);

  await room.localParticipant.setCameraEnabled(true, {
    resolution: { width: 320, height: 240 },
    frameRate: 15
  });

  await room.localParticipant.setMicrophoneEnabled(true);

  room.localParticipant.videoTracks.forEach(p => {
    p.track.attach(document.getElementById("localVideo"));
  });

  document.getElementById("status").innerText = "Connected";
}

/* ===== CONTROLS ===== */
function toggleMic() {
  micOn = !micOn;
  room?.localParticipant.setMicrophoneEnabled(micOn);
}

function toggleCam() {
  camOn = !camOn;
  room?.localParticipant.setCameraEnabled(camOn);
}

function leave() {
  room?.disconnect();
  if (Telegram?.WebApp) Telegram.WebApp.close();
}
</script>

</body>
</html>
